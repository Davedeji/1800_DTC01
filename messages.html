<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Pro Buddy - PAGE TITLE Goes Here</title>
    <meta name="Welcome" content="Pro Buddy">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"> -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous">
    </script>


    <!-- Google Icons (Material Design) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Firebase CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />

    <!-- Firebase Keys -->
    <script src="/scripts/firebaseAPI.js"></script>

    <!-- Custom CSS & JS -->


    <!-- Header Component-->
    <script src="/components/header.js" type="text/javascript" defer></script>


</head>
<style>
    /* .card {
        break-inside: avoid;
    }
    .card-columns {
        column-count: 2;
    } */

    .card {
        border-width: 0;
    }

    .message-container {
        padding-bottom: 80px;
    }
</style>

<body>
    <!-- Import header component in head and use this tag. Done!! -->
    <div id="nav-placeholder"></div>
    <main>
        <div class="message-container">
            <div class="text-center">
                <div class="mx-4">
                    <h4 id="matchedUserName">John Doe</h4>
                    <p class="text-secondary mb-1" id="matchedUserDescription">Full Stack Developer</p>
                </div>
            </div>

            <div class="card-deck mb-5 mx-4" id="cardGroup">

            </div>
            <div class="form-row fixed-bottom align-items-center mx-4">
                <div class="col-auto">
                    <input type="text" class="form-control mb-2" id="messageInput" placeholder="Type message here">
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-primary mb-2" onclick="writeMessage()">Send</button>
                </div>
            </div>
        </div>

        <form>

        </form>
    </main>
</body>

<script>
    function getUserIDs() {
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                var docRef = db.collection("users").doc(user.uid)
                docRef.get().then((doc) => {
                    if (doc.exists) {
                        otherUserID = doc.data().match
                        startMessage(user.uid, otherUserID)
                        getOtherUserProperties(otherUserID)
                    } else {
                        console.log("No such document!");
                    }
                }).catch((error) => {
                    console.log("Error getting document:", error);
                });
            } else {

            }
        });
    }
    getUserIDs()

    function createMessage(userID, otherUserID) {
        setData = {}
        users = {}
        users[otherUserID] = true
        users[userID] = true
        setData["users"] = users
        console.log(setData)
        var doc = db.collection("messages").doc()
        doc.set(setData).then(() => {
            window.localStorage.setItem('chatID', doc.id);
            getMessages(doc.id)
        })
    }

    function startMessage(userID, otherUserID) {
        let ref = db.collection("messages").where('users.' + userID, '==', true).where('users.' + otherUserID, '==',
            true)
        ref.get()
            .then((querySnapshot) => {
                if (!querySnapshot.empty) {
                    getMessages(querySnapshot.docs[0].id)
                    window.localStorage.setItem('chatID', querySnapshot.docs[0].id);
                } else {
                    createMessage(userID, otherUserID)
                }
            })
    }

    function getOtherUserProperties(userID) {
        name = ""
        description = ""
        var docRef = db.collection("users").doc(userID)

        docRef.get().then((doc) => {
            if (doc.exists) {
                name = doc.data().name
                description = doc.data().description
                updateMatchedUserDisplay(name, description)
            } else {
                console.log("No such document!");
            }
        }).catch((error) => {
            console.log("Error getting document:", error);
        });
    }

    function updateMatchedUserDisplay(name, description) {
        document.getElementById("matchedUserName").innerHTML = name
        document.getElementById("matchedUserDescription").innerHTML = description
    }

    function getMessages(chatID) {
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                var docRef = db.collection("messages").doc(chatID).collection("messages")
                docRef.orderBy("sentAt").onSnapshot((querySnapshot) => {
                    querySnapshot.docChanges().forEach((change) => {
                        // doc.data() is never undefined for query doc snapshots
                        const timeStampDate = change.doc.data().sentAt;
                        let date = change.doc.data().sentAt
                        date = date.toDate()
                        let time = date.toLocaleTimeString("en-us", {
                            timeStyle: 'short'
                        });
                        date = date.toLocaleDateString("en-us", {
                            dateStyle: 'medium'
                        });
                        let finalDate = date + " " + time
                        var card = $(createCard("", change.doc.data().messageText, finalDate,
                            user
                            .uid == change.doc.data().sentBy))
                        var element = document.getElementById("cardGroup");
                        $('#cardGroup').append(card);
                    });
                    window.scrollTo(0, document.body.scrollHeight)
                });
            } else {
                // User is signed out
                // ...
            }
        });

    }

    function writeMessage() {
        const user = firebase.auth().currentUser;
        if (user) {
            // User logged in already or has just logged in.sd
            var chatID = window.localStorage.getItem('chatID');
            var docRef = db.collection("messages").doc(chatID).collection("messages");
            docRef.add({
                    "messageText": document.getElementById("messageInput").value,
                    "sentAt": firebase.firestore.Timestamp.fromDate(new Date()),
                    "sentBy": user.uid
                })
                .then(() => {
                    console.log("Document successfully written!");
                    document.getElementById("messageInput").value = ""
                })
                .catch((error) => {
                    console.error("Error writing document: ", error);
                });
        } else {
            // User not logged in or has just logged out.
        }

    }

    function createCard(title, message, sentAt, isSender) {
        console.log(isSender)
        if (isSender == true) {
            return `<div class="card text-end" style="">
                <div class="card-body ">
                    <h5 class="card-title">${title}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${sentAt}</h6>
                    <p class="card-text">${message}</p>
                </div>
            </div>`;
        } else {
            return `<div class="card" style="">
                <div class="card-body ">
                    <h5 class="card-title">${title}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">${sentAt}</h6>
                    <p class="card-text">${message}</p>
                </div>
            </div>`;
        }

    }
</script>

</html>