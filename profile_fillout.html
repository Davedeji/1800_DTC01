<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Pro Buddy - Home</title>
  <meta name="Welcome" content="Pro Buddy">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <!-- Google Icons (Material Design)-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


  <!-- Bootstrap FirebaseUI CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">


  <!-- Firebase 8 CDNs-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="./scripts/firebaseAPI.js"></script>
  <script src="/components/header.js" type="text/javascript" defer></script>



  <!-- Link to the api keys for your firebase project -->

  <style>
    * {
      margin: 0;
      padding: 0;
    }

    #image1 {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
    }

    h1 {
      text-align: center;
    }

    h6 {
      text-align: center;
    }

    p {
      text-align: center;
    }
  </style>
</head>



<body>

  <!------------------------------------>
  <!-- Your own HTML layout goes here -->
  <!------------------------------------>
  <div id="nav-placeholder"></div>
  <div class="container">
    <h1>User Profile </h1>

    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Admin" class="rounded-circle" width="150"
      id="profilePic">
    <button class="btn btn-outline-primary" onclick="document.getElementById('profilePicFile').click()">Change Profile
      Picture</button>
    <input type="file" id="profilePicFile" style="display:none">
    <form>
      <fieldset class="mb-3" id="personalInfoFields" disabled>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="nameInput" class="form-control" placeholder="Enter your name">
        </div>
        <div class="form-group">
          <label>Age</label>
          <input type="text" id="ageInput" class="form-control" placeholder="Enter your age">
        </div>
        <div class="form-group">
          <label>City</label>
          <input type="text" id="cityInput" class="form-control" placeholder="Enter your city">
        </div>

        <div class="form-group">
          <label> Tell us about yourself!</label>
          <input type="text" id="introInput" class="form-control" placeholder="Your intro goes here"
            style="height: 100px">
        </div>





      </fieldset>
      <div class="d-flex justify-content-end mt-5">
        <button type="button" class="btn btn-secondary" onclick="editUserInfo()">Edit</button>
        <span style="width: 10px"></span>
        <button type="button" class="btn btn-primary" onclick="saveUserInfo()">Save</button>
      </div>
    </form>
  </div>

  <footer class="navbar justify-content-evenly bg-secondary fixed-bottom">
    <i class="material-icons">home</i>
    <i class="material-icons">check</i>
    <i class="material-icons">language</i>
    <i class="material-icons">upload_file</i>
    <i class="material-icons">chat</i>

  </footer>

  <div class="text-center py-5">
  </div>



  <!--------------------------------------------------->
  <!-- Your Javascript Libraries and scripts go here -->
  <!--------------------------------------------------->

  <!-- Option 1: Bootstrap Bundle with Popper -->
  <script>

    var currentUser

    function populateInfo() {
      firebase.auth().onAuthStateChanged(user => {
        // Check if user is signed in:
        if (user) {

          //go to the correct user document by referencing to the user uid
          currentUser = db.collection("users").doc(user.uid)
          //get the document for current user.
          currentUser.get()
            .then(userDoc => {
              //get the data fields of the user
              var userName = userDoc.data().name;
              // console.log(userName)
              var userAge = userDoc.data().age;
              var userCity = userDoc.data().city;
              var userDescription = userDoc.data().description;

              //if the data fields are not empty, then write them in to the form.
              if (userName != null) {
                document.getElementById("nameInput").value = userName;
              }
              if (userAge != null) {
                document.getElementById("ageInput").value = userAge;
              }
              if (userCity != null) {
                document.getElementById("cityInput").value = userCity;
              }
              if (userDescription != null) {
                document.getElementById("introInput").value = userDescription;
              }
            })
        } else {
          // No user is signed in.
          console.log("No user is signed in");
        }
      });
    }





    //call the function to run it 
    populateInfo();

    function editUserInfo() {
      // console.log("edit is clicked")
      document.getElementById('personalInfoFields').disabled = false;
    }

    function saveUserInfo() {
      // console.log("save is clicked")
      //grab values from the form that user populated, then put 
      userName = document.getElementById('nameInput').value;       //get the value of the field with id="nameInput"
      userAge = document.getElementById('ageInput').value;     //get the value of the field with id="schoolInput"
      userCity = document.getElementById('cityInput').value;
      userDescription = document.getElementById('introInput').value;      //get the value of the field with id="cityInput"
      // console.log("input is " userName, userAge, userCity)

      // write the values into database:
      currentUser.update({
        name: userName,
        age: userAge,
        city: userCity,
        description: userDescription
      })
        .then(() => {
          console.log("Document successfully updated!");
        })

      document.getElementById('personalInfoFields').disabled = true;
    }





    function AddUploadListener() {
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          console.log(user.uid)
          const fileInput = document.getElementById("profilePicFile"); // pointer #1
          const image = document.getElementById("profilePic"); // pointer #2

          //attach listener to input file
          //when this file changes, do something
          fileInput.addEventListener('change', function (e) {

            //the change event returns a file "e.target.files[0]"
            var blob = URL.createObjectURL(e.target.files[0]);
            var targetfile = (e.target.files[0]);

            //change the DOM img element source to point to this file
            image.src = blob; //assign the "src" property of the "img" tag

            //do database stuff:  add to menu collection
            storeImage(user.uid, targetfile);
          })
        } else { console.log("no user signed in") }
      });
    }

    AddUploadListener();

    function storeImage(userid, pickedfile) {
      var storageRef = firebase.storage().ref("images/" + userid + ".jpg"); // Get reference
      var metadata = {
        contentType: 'image/jpeg',
      };

      // Upload picked file to cloud storage
      storageRef.put(pickedfile, metadata)
        .then(function () {
          storageRef.getDownloadURL() //get URL of the uploade file
            .then(function (url) {
              console.log(url); // Save the URL into users collection
              db.collection("users").doc(userid).update({
                "profilePic": url
              })
            })
        });

    }

    function displayProfilePic() {
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          db.collection("users").doc(user.uid)
            .get()
            .then(function (snap) {


              var pic = snap.data().profilePic;
              
              $("#profilePic").attr("src", pic);
                emptypic();


            })
        }
      })
    }
    displayProfilePic();

    function emptypic() {
      var x = document.getElementById("profilePic").getAttribute("src");
      if (x == "" || x == null) {
        $("#profilePic").attr("src", "https://bootdey.com/img/Content/avatar/avatar7.png");
      }

    }
  </script>


</body>

</html>